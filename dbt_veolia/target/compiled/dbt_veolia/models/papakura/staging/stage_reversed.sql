WITH BASE AS (SELECT GBI.GBIINVOICE,GBI.GBILEDGER , GBI.GBICUR_NO_DAYS, GBI.GBITOT_DOLLAR, GBI.GBIREV_TYPE ,
LAG(GBI.GBITOT_DOLLAR) OVER(PARTITION BY GBI.GBILEDGER ORDER BY GBI.GBIINVOICE DESC) FAT_ANTERIOR,
GBI.GBITOT_DOLLAR + LAG(GBI.GBITOT_DOLLAR) OVER(PARTITION BY GBI.GBILEDGER ORDER BY GBI.GBIINVOICE DESC) AS DIF_FATURAS,
CASE 
	WHEN (GBI.GBICUR_NO_DAYS + LAG(GBI.GBICUR_NO_DAYS) OVER(PARTITION BY GBI.GBILEDGER ORDER BY GBI.GBIINVOICE DESC)) = 0 or (GBI.GBITOT_DOLLAR + LAG(GBI.GBITOT_DOLLAR) OVER(PARTITION BY GBI.GBILEDGER ORDER BY GBI.GBIINVOICE DESC)) IN (0,1) OR GBI.GBITOT_DOLLAR < 0THEN 
1 	ELSE 0 END AS REVERSED,
CASE WHEN (GBI.GBICUR_NO_DAYS + LAG(GBI.GBICUR_NO_DAYS) OVER(PARTITION BY GBI.GBILEDGER ORDER BY GBI.GBIINVOICE DESC)) = 0 or (GBI.GBITOT_DOLLAR + LAG(GBI.GBITOT_DOLLAR) OVER(PARTITION BY GBI.GBILEDGER ORDER BY GBI.GBIINVOICE DESC)) = 0  THEN 
GBI.GBITOT_DOLLAR 
WHEN  GBI.GBITOT_DOLLAR < 0 THEN GBITOT_DOLLAR * -1
ELSE GBI.GBITOT_DOLLAR END AS GBITOT_DOLLAR_ADJ
FROM GBINVOICE GBI
--WHERE GBILEDGER IN (100009107)
)

SELECT * FROM BASE 
WHERE REVERSED = 1