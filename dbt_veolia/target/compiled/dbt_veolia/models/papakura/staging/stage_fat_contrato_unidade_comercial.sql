WITH TCHARGE AS (SELECT TC.*,

CASE 
	WHEN TC.TARC$CODE       NOT 
	IN (SELECT DISTINCT CRAT$CODE FROM TARRATE)
	THEN TC.TARC$TEMPLATE ELSE TC.TARC$CODE 
END AS TARC$CODE2
FROM TARCHARGE TC
)
,TR AS (
SELECT 
CRAT$CODE,
CRAT$DATE inicio,  
DATEADD(DAY,-1,COALESCE(LAG(CRAT$DATE,1) OVER(PARTITION BY CRAT$CODE ORDER BY CRAT$DATE DESC),DATEADD(YEAR,1,CRAT$DATE))) fim,
t.CRAT$RATE  
FROM TARRATE t)

, RATES AS (
SELECT TC.TARC$CODE,TR.* FROM TCHARGE TC
INNER JOIN TR ON TR.CRAT$CODE = TC.TARC$CODE2

)

,firs_contract_temp as (select CCON_CONSUMER as CONSUMER, CCON_STARTDATE AS DATA_PRIMEIRO_CONTRATO, row_number() over(partition by CCON_CONSUMER order by CCON_STARTDATE,CCON_SEQ) as rn from EMS_CON_CONTRACT ecc 
)
,first_contract as (select * from firs_contract_temp where rn =1)
, ECC AS (SELECT ECC.*,FC.*,case when DATEADD(DAY,-1,COALESCE(LAG(CCON_STARTDATE,1) OVER(PARTITION BY CCON_CONSUMER ORDER BY CCON_SEQ DESC),DATEADD(YEAR,1,'2022-07-01'))) < CCON_STARTDATE THEN CCON_STARTDATE ELSE DATEADD(DAY,-1,COALESCE(LAG(CCON_STARTDATE,1) OVER(PARTITION BY CCON_CONSUMER ORDER BY CCON_SEQ DESC),DATEADD(YEAR,1,'2022-07-01'))) END as  ENDDATE FROM "papakura_20221223"."dbo"."EMS_CON_CONTRACT" ECC
left join first_contract FC ON FC.CONSUMER = ECC.CCON_CONSUMER
WHERE  ECC.CCON_PLANID1 IN (SELECT DISTINCT ECPLAN_KEY FROM  "papakura_20221223"."dbo"."EMS_CON_PLAN#FIXED_LIST"))
,CONTRATO_UNIDADE AS (
SELECT
-- ROW_NUMBER() OVER(ORDER BY ID_CONTRATO) as ID_CONTRATO_UNIDADE_COMERCIAL,
-- CASE 
-- 	WHEN inicio > ECC.CCON_STARTDATE THEN  ECC.CCON_STARTDATE ELSE inicio
-- END as DT_INICIO_VIGENCIA,
-- CASE 
-- 	WHEN fim > ECC.ENDDATE THEN ECC.ENDDATE ELSE fim
-- END AS  DT_FIM_VIGENCIA,
case 
	when datepart(MONTH,
		CASE 
			WHEN ROW_NUMBER() OVER(PARTITION BY ECC.CCON_CONSUMER, ECC.CCON_SEQ ORDER BY ECC.CCON_SEQ DESC,TR.inicio DESC) = 1 AND TR.inicio < DATEADD(DAY,1,TR.fim) AND DATEADD(DAY,1,TR.fim) < ECC.ENDDATE THEN DATEADD(DAY,1,TR.fim)
			WHEN ROW_NUMBER() OVER(PARTITION BY ECC.CCON_CONSUMER, ECC.CCON_SEQ ORDER BY ECC.CCON_SEQ,TR.inicio) = 1 THEN ECC.CCON_STARTDATE ELSE TR.inicio END) = 06 AND
			datepart(DAY,CASE 
			WHEN ROW_NUMBER() OVER(PARTITION BY ECC.CCON_CONSUMER, ECC.CCON_SEQ ORDER BY ECC.CCON_SEQ DESC,TR.inicio DESC) = 1 AND TR.inicio < DATEADD(DAY,1,TR.fim) AND DATEADD(DAY,1,TR.fim) < ECC.ENDDATE THEN DATEADD(DAY,1,TR.fim)
			WHEN ROW_NUMBER() OVER(PARTITION BY ECC.CCON_CONSUMER, ECC.CCON_SEQ ORDER BY ECC.CCON_SEQ,TR.inicio) = 1 THEN ECC.CCON_STARTDATE ELSE TR.inicio END) = 30	THEN DATEADD(DAY,1,
				CASE 
					WHEN ROW_NUMBER() OVER(PARTITION BY ECC.CCON_CONSUMER, ECC.CCON_SEQ ORDER BY ECC.CCON_SEQ DESC,TR.inicio DESC) = 1 AND TR.inicio < DATEADD(DAY,1,TR.fim) AND DATEADD(DAY,1,TR.fim) < ECC.ENDDATE THEN DATEADD(DAY,1,TR.fim)
					WHEN ROW_NUMBER() OVER(PARTITION BY ECC.CCON_CONSUMER, ECC.CCON_SEQ ORDER BY ECC.CCON_SEQ,TR.inicio) = 1 THEN ECC.CCON_STARTDATE ELSE TR.inicio END)
				ELSE CASE 
			WHEN ROW_NUMBER() OVER(PARTITION BY ECC.CCON_CONSUMER, ECC.CCON_SEQ ORDER BY ECC.CCON_SEQ DESC,TR.inicio DESC) = 1 AND TR.inicio < DATEADD(DAY,1,TR.fim) AND DATEADD(DAY,1,TR.fim) < ECC.ENDDATE THEN DATEADD(DAY,1,TR.fim)
			WHEN ROW_NUMBER() OVER(PARTITION BY ECC.CCON_CONSUMER, ECC.CCON_SEQ ORDER BY ECC.CCON_SEQ,TR.inicio) = 1 THEN ECC.CCON_STARTDATE ELSE TR.inicio END END as DT_INICIO_VIGENCIA,

CASE 
	WHEN ROW_NUMBER() OVER(PARTITION BY ECC.CCON_CONSUMER, ECC.CCON_SEQ ORDER BY ECC.CCON_SEQ,TR.inicio) = 1 AND ECC.CCON_STARTDATE < DATEADD(DAY,-1,TR.inicio) THEN DATEADD(DAY,-1,TR.inicio)
	WHEN ROW_NUMBER() OVER(PARTITION BY ECC.CCON_CONSUMER, ECC.CCON_SEQ ORDER BY ECC.CCON_SEQ DESC,TR.inicio DESC) = 1 
THEN ECC.ENDDATE ELSE TR.fim END as DT_FIM_VIGENCIA,
NULL as QT_CONSUMO_FATURAMENTO,
COALESCE(TR.CRAT$RATE/1000000,0)  as VL_FATURAMENTO,
NULL as PC_DESCONTO_AGUA,
NULL as PC_DESCONTO_ESGOTO,
NULL  as PC_DESCONTO_SERVICO,
NULL as FL_ESTENDER_ESGOTO,
NULL as FL_ESTENDER_SERVICO_HIDROMETRO,
NULL as FL_PERDER_BENEFICIO_EXCESSO_CONSUMO,
coalesce(ccuc.CH_MATRICULA_UNIDADE, 0) as CH_MATRICULA_UNIDADE,
coalesce(FC.ID_CONTRATO, 0) as ID_CONTRATO,
null as ID_USUARIO,
NULL as ID_SERVICO_CANCELAMENTO,
NULL as ID_SERVICO_CADASTRO,
NULL as HR_INICIO,
NULL as HR_FIM,
'N' as FL_COBRAR_EXCESSO_CONSUMO_CATEGORIA_SECUNDARIA,
'S' as FL_VALOR_FIXO,
0.0 as PC_DESCONTO_LIXO,
cast(0 as BIT) as FL_ESTENDER_LIXO,
NULL as ID_TABELA_BENEFICIO_APOSENTADO_REGRA,
FC.CODE,
FC.CODE AS MIG_CODE_TEMP,
cast(TR.CRAT$RATE as decimal(16,3)) as CRAT$RATE,
ECC.CCON_PLANID1,
ECC.DATA_PRIMEIRO_CONTRATO,
inicio,
fim,
ECC.CCON_STARTDATE,
ECC.ENDDATE,
ccuc.MIG_PK_TEMP,
ECC.CCON_CONSUMER
-- CASE WHEN LEFT(ECC.CCON_PLANID1,10) = 'ICST0SS0IC' THEN 'ICST0SS0IC' ELSE ECC.CCON_PLANID1 END AS CCON_PLANID1
FROM ECC
left join "papakura_20221223"."dbo_mig"."cad_cliente_unidade_comercial" ccuc on ccuc.MIG_PK_TEMP = ECC.CCON_CONSUMER
left JOIN  "papakura_20221223"."dbo"."EMS_CON_PLAN#FIXED_LIST" ECPFL ON ECPFL.ECPLAN_KEY = ECC.CCON_PLANID1 
LEFT JOIN RATES TR ON TR.TARC$CODE = ECPFL.ECPLAN_FCHGCODE 
and (inicio >=  ECC.CCON_STARTDATE AND fim <= ECC.ENDDATE )
left JOIN "papakura_20221223"."dbo_mig"."fat_contrato" FC ON FC.CODE = ECPFL.ECPLAN_FCHGCODE


)

SELECT 
ROW_NUMBER() OVER(ORDER BY ID_CONTRATO) as ID_CONTRATO_UNIDADE_COMERCIAL,
 DT_INICIO_VIGENCIA,
-- Case When ENDDATE < fim And ENDDATE < DT_FIM_VIGENCIA Then ENDDATE
--             When fim < ENDDATE And fim < DT_FIM_VIGENCIA Then fim 
--             Else DT_FIM_VIGENCIA
--             End As DT_FIM_VIGENCIA,
DT_FIM_VIGENCIA,
QT_CONSUMO_FATURAMENTO,
VL_FATURAMENTO,
PC_DESCONTO_AGUA,
PC_DESCONTO_ESGOTO,
PC_DESCONTO_SERVICO,
FL_ESTENDER_ESGOTO,
FL_ESTENDER_SERVICO_HIDROMETRO,
FL_PERDER_BENEFICIO_EXCESSO_CONSUMO,
CH_MATRICULA_UNIDADE,
ID_CONTRATO,
ID_USUARIO,
ID_SERVICO_CANCELAMENTO,
ID_SERVICO_CADASTRO,
HR_INICIO,
HR_FIM,
FL_COBRAR_EXCESSO_CONSUMO_CATEGORIA_SECUNDARIA,
FL_VALOR_FIXO,
PC_DESCONTO_LIXO,
FL_ESTENDER_LIXO,
ID_TABELA_BENEFICIO_APOSENTADO_REGRA,
CODE,
MIG_CODE_TEMP,
CRAT$RATE,
CCON_PLANID1,
DATA_PRIMEIRO_CONTRATO,
inicio,
fim,
CCON_STARTDATE,
ENDDATE,
MIG_PK_TEMP
FROM CONTRATO_UNIDADE
WHERE DT_INICIO_VIGENCIA IS NOT NULL  and inicio is not null
AND DT_INICIO_VIGENCIA <= DT_FIM_VIGENCIA 
AND (DT_INICIO_VIGENCIA>=CCON_STARTDATE AND   DT_FIM_VIGENCIA <=ENDDATE)

GROUP BY
MIG_PK_TEMP,
CH_MATRICULA_UNIDADE,
DT_INICIO_VIGENCIA,
DT_FIM_VIGENCIA,
inicio,
fim,
CCON_STARTDATE,
ENDDATE,
CCON_PLANID1,
CODE,
ID_CONTRATO,
MIG_CODE_TEMP,
CRAT$RATE,
VL_FATURAMENTO,
QT_CONSUMO_FATURAMENTO,
PC_DESCONTO_AGUA,
PC_DESCONTO_ESGOTO,
PC_DESCONTO_SERVICO,
FL_ESTENDER_ESGOTO,
FL_ESTENDER_SERVICO_HIDROMETRO,
FL_PERDER_BENEFICIO_EXCESSO_CONSUMO,
ID_USUARIO,
ID_SERVICO_CANCELAMENTO,
ID_SERVICO_CADASTRO,
HR_INICIO,
HR_FIM,
FL_COBRAR_EXCESSO_CONSUMO_CATEGORIA_SECUNDARIA,
FL_VALOR_FIXO,
PC_DESCONTO_LIXO,
FL_ESTENDER_LIXO,
ID_TABELA_BENEFICIO_APOSENTADO_REGRA,
DATA_PRIMEIRO_CONTRATO