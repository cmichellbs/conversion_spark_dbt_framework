WITH 

OTHER AS (SELECT GBSSTATEMENT, 
SUM(GBSTRAN_AMOUNT) sum_damt
-- 0 sum_damt 

FROM  GBSTATEMENT#TRANS gt 
WHERE GBSTRAN_TRN_TYPE  in (select mig_gbictrn_type_temp from "papakura_20221223"."dbo_mig"."fat_servico_unidade"
where MIG_TARIFA_FIXA_TEMP ='N' and MIG_GBICTRN_TYPE_TEMP not in ('WSERV','MIN')
)
group by GBSSTATEMENT)

,BASE AS (
select g.GBIDATE ,DENSE_RANK() over(partition by gi.GBSSTATEMENT ORDER BY GBSINVOICENO ASC) RN, gi.* from GBSTATEMENT#INVOICE gi
LEFT JOIN GBSTATEMENT#TRANS gt ON gt.GBSSTATEMENT = gi.GBSSTATEMENT 
left join GBINVOICE g on g.GBIINVOICE = gi.GBSINVOICENO 

)

,INVOICE AS (
SELECT MAX(GBSSTATEMENT) GBSSTATEMENT,MAX(GBSINVOICENO) GBSINVOICENO FROM BASE
WHERE RN =1
GROUP BY GBSSTATEMENT
)

,OTHERS AS (SELECT OTHER.*,INVOICE.GBSINVOICENO FROM "papakura_20221223"."dbo_mig"."stage_other" OTHER
INNER JOIN INVOICE ON INVOICE.GBSSTATEMENT = OTHER.GBSSTATEMENT)

,FATURAS AS (
	SELECT 
	GBI.GBIINVOICE,
	GBI.GBIDATE,
	GBI.GBISTATEMENT_NO ,
	GBI.GBILEDGER , 
	GBI.GBICUR_NO_DAYS, 
	GBI.GBITOT_DOLLAR, 
	GBI.GBIREV_TYPE ,
	GI.GBSINVOICE_TOTAL,
LAG(GBI.GBITOT_DOLLAR) OVER(PARTITION BY GBI.GBILEDGER ORDER BY GBI.GBIINVOICE DESC) FAT_ANTERIOR,
(GBI.GBITOT_DOLLAR + LAG(GBI.GBITOT_DOLLAR) OVER(PARTITION BY GBI.GBILEDGER ORDER BY GBI.GBIINVOICE DESC)) AS DIF_FATURAS,

CASE WHEN ssf.status = 2 THEN 0
   WHEN ssf.status = 1 THEN 0
   WHEN ssf.status = 5 THEN 0
   ELSE 1
   END 
       AS REVERSED,

-- CASE WHEN ssf.cancelado =1 THEN 1 else 0 end as REVERSED,

CASE 
WHEN (GBI.GBICUR_NO_DAYS + LAG(GBI.GBICUR_NO_DAYS) OVER(PARTITION BY GBI.GBILEDGER ORDER BY GBI.GBIINVOICE DESC)) = 0 or (GBI.GBITOT_DOLLAR + LAG(GBI.GBITOT_DOLLAR) OVER(PARTITION BY GBI.GBILEDGER ORDER BY GBI.GBIINVOICE DESC)) = 0  THEN 
GBI.GBITOT_DOLLAR 
WHEN  GBI.GBITOT_DOLLAR < 0 THEN GBITOT_DOLLAR * -1
ELSE GBI.GBITOT_DOLLAR END AS GBITOT_DOLLAR_ADJ
FROM GBINVOICE GBI
left join "papakura_20221223"."dbo_mig"."stage_status_fatura" ssf on ssf.GBIINVOICE = GBI.GBIINVOICE
left join GBSTATEMENT#INVOICE GI ON GI.GBSINVOICENO = GBI.GBIINVOICE

)
,FATURAS_MOV AS (

SELECT 
CONCAT(MAX(DEBT.DKEY),997) DKEY, MAX(DEBT.DLEDGER) AS DLEDGER,MAX(DEBT.DDATETIME) AS DDATETIME,
(COALESCE(CASE WHEN MAX(FATURAS.REVERSED) = 1 
AND MAX(GBSINVOICE_TOTAL) > 0 
THEN MAX(GBSINVOICE_TOTAL) ELSE NULL END*-1,
CASE WHEN MAX(FATURAS.REVERSED) = 1 
AND MAX(GBSINVOICE_TOTAL) < 0
THEN MAX(GBSINVOICE_TOTAL) ELSE NULL END) + coalesce(0,0))DAMT, 

MAX(DEBT.DSTATEMENT) AS DSTATEMENT,MAX(DEBT.DINVOICEREF) AS DINVOICEREF,'FATURA' AS DTYPE, 'S' AS IS_FATURA, 1 AS FAT_CANC,MAX(DEBT.DDATEDUE) DDATEDUE FROM DEBT
INNER JOIN FATURAS ON FATURAS.GBIINVOICE = DEBT.DINVOICEREF
LEFT JOIN OTHERS ON OTHERS.GBSINVOICENO = FATURAS.GBIINVOICE
WHERE DEBT.DINVOICEREF IS NOT NULL AND FATURAS.REVERSED = 1
GROUP BY DEBT.DINVOICEREF,DEBT.DDATE

UNION 

SELECT 
CONCAT(MAX(DEBT.DKEY),998) DKEY, MAX(DEBT.DLEDGER) AS DLEDGER,MAX(DEBT.DDATETIME) AS DDATETIME,
(COALESCE(CASE WHEN MAX(FATURAS.REVERSED) = 1 
AND MAX(GBSINVOICE_TOTAL) > 0 
THEN MAX(GBSINVOICE_TOTAL) ELSE NULL END
,
CASE WHEN MAX(FATURAS.REVERSED) = 1 
AND MAX(GBSINVOICE_TOTAL) < 0 
THEN MAX(GBSINVOICE_TOTAL) ELSE NULL END *-1) + coalesce(0,0))DAMT, 
MAX(DEBT.DSTATEMENT) AS DSTATEMENT,MAX(DEBT.DINVOICEREF) AS DINVOICEREF,'FATURA' AS DTYPE, 'S' AS IS_FATURA, 0 AS FAT_CANC,MAX(DEBT.DDATEDUE) DDATEDUE FROM DEBT

INNER JOIN FATURAS ON FATURAS.GBIINVOICE = DEBT.DINVOICEREF
LEFT JOIN OTHERS ON OTHERS.GBSINVOICENO = FATURAS.GBIINVOICE
WHERE DEBT.DINVOICEREF IS NOT NULL AND FATURAS.REVERSED = 1
GROUP BY DEBT.DINVOICEREF,DEBT.DDATE

UNION  

SELECT 
CONCAT(MAX(DEBT.DKEY),999) DKEY, MAX(DEBT.DLEDGER) AS DLEDGER,MAX(DEBT.DDATETIME) AS DDATETIME,((MAX(GBSINVOICE_TOTAL)) + coalesce(max(sum_damt),0)) DAMT, MAX(DEBT.DSTATEMENT) AS DSTATEMENT,MAX(DEBT.DINVOICEREF) AS DINVOICEREF,'FATURA' AS DTYPE, 'S' AS IS_FATURA, 0 AS FAT_CANC ,MAX(DEBT.DDATEDUE) DDATEDUE FROM "papakura_20221223"."dbo"."DEBT" DEBT
INNER JOIN FATURAS ON FATURAS.GBIINVOICE = DEBT.DINVOICEREF
LEFT JOIN OTHERS ON OTHERS.GBSINVOICENO = FATURAS.GBIINVOICE
WHERE DEBT.DINVOICEREF IS NOT NULL AND FATURAS.REVERSED = 0
GROUP BY DEBT.DINVOICEREF,DEBT.DDATE


)
,DEBT_ADJ AS (
SELECT DEBT.DKEY ,DEBT.DLEDGER,DEBT.DDATETIME,DEBT.DAMT, DEBT.DSTATEMENT,DEBT.DINVOICEREF,DEBT.DTYPE,'N' AS IS_FATURA, NULL AS FAT_CANC,DEBT.DDATEDUE FROM "papakura_20221223"."dbo"."DEBT" DEBT
WHERE 1=1
-- and  CONCAT(DEBT.DKEY,999) not in (SELECT DKEY from FATURAS_MOV) 
-- and  DEBT.DSTATEMENT IS NULL

and  DEBT.DINVOICEREF IS NULL

UNION

SELECT DKEY, DLEDGER, DDATETIME, DAMT ,DSTATEMENT,DINVOICEREF,DTYPE,IS_FATURA,FAT_CANC,DDATEDUE FROM FATURAS_MOV

)


SELECT MAX(DKEY) AS DKEY, MAX(DLEDGER) DLEDGER, MAX(DDATETIME) DDATETIME, SUM(DAMT) DAMT,MAX(DSTATEMENT) DSTATEMENT,MAX(DINVOICEREF) DINVOICEREF,MAX(DTYPE) DTYPE,MAX(IS_FATURA) IS_FATURA,MAX(FAT_CANC) FAT_CANC,MAX(DDATEDUE) DDATEDUE FROM DEBT_ADJ
WHERE 1=1
 and DLEDGER IN (SELECT CACCT FROM "papakura_20221223"."dbo"."CONSUMER")
-- AND DLEDGER =400103911

and (DTYPE not in (select mig_gbictrn_type_temp from "papakura_20221223"."dbo_mig"."fat_servico_unidade"
where MIG_TARIFA_FIXA_TEMP ='N' and MIG_GBICTRN_TYPE_TEMP not in ('WSERV','MIN')

) 
and DLEDGER not in (659659659,659000088)
)
GROUP BY DLEDGER,DSTATEMENT, DINVOICEREF,DTYPE,FAT_CANC,CAST(DDATETIME AS DATE),DDATETIME,DKEY

UNION

SELECT MAX(DKEY) AS DKEY, MAX(DLEDGER) DLEDGER, MAX(DDATETIME) DDATETIME, SUM(DAMT) DAMT,MAX(DSTATEMENT) DSTATEMENT,MAX(DINVOICEREF) DINVOICEREF,MAX(DTYPE) DTYPE,MAX(IS_FATURA) IS_FATURA,MAX(FAT_CANC) FAT_CANC,MAX(DDATEDUE) DDATEDUE FROM DEBT_ADJ
WHERE 1=1
 and DLEDGER IN (SELECT CACCT FROM "papakura_20221223"."dbo"."CONSUMER")
AND DLEDGER in (659659659,659000088)

and (DTYPE not in (select mig_gbictrn_type_temp from "papakura_20221223"."dbo_mig"."fat_servico_unidade"
where MIG_TARIFA_FIXA_TEMP ='N' 
and MIG_GBICTRN_TYPE_TEMP not in ('WSERV','MIN')

) 
-- and DLEDGER <>  659659659
)
GROUP BY DLEDGER,DSTATEMENT, DINVOICEREF,DTYPE,FAT_CANC,CAST(DDATETIME AS DATE),DDATETIME,DKEY

UNION

SELECT MAX(DKEY) AS DKEY, MAX(DLEDGER) DLEDGER, MAX(DDATETIME) DDATETIME, SUM(DAMT) DAMT,MAX(DSTATEMENT) DSTATEMENT,MAX(DINVOICEREF) DINVOICEREF,MAX(DTYPE) DTYPE,MAX(IS_FATURA) IS_FATURA,MAX(FAT_CANC) FAT_CANC,MAX(DDATEDUE) DDATEDUE FROM DEBT_ADJ
WHERE 1=1
 and DLEDGER IN (SELECT CACCT FROM "papakura_20221223"."dbo"."CONSUMER")
AND DLEDGER not in (659659659,659000088)
and DINVOICEREF is null
and (DSTATEMENT is null or DSTATEMENT NOT IN (SELECT GBSSTATEMENT FROM "papakura_20221223"."dbo_mig"."stage_other") )
and (DTYPE in (select mig_gbictrn_type_temp from "papakura_20221223"."dbo_mig"."fat_servico_unidade"
where MIG_TARIFA_FIXA_TEMP ='N' 
and MIG_GBICTRN_TYPE_TEMP not in ('WSERV','MIN')

) 
-- -- and DLEDGER <>  659659659
)
GROUP BY DLEDGER,DSTATEMENT, DINVOICEREF,DTYPE,FAT_CANC,CAST(DDATETIME AS DATE),DDATETIME,DKEY