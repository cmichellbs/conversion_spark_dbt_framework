
   
  USE [papakura_20221223];
  if object_id ('"dbo_mig"."fat_servico_unidade__dbt_tmp_temp_view"','V') is not null
      begin
      drop view "dbo_mig"."fat_servico_unidade__dbt_tmp_temp_view"
      end


   
   
  USE [papakura_20221223];
  if object_id ('"dbo_mig"."fat_servico_unidade__dbt_tmp"','U') is not null
      begin
      drop table "dbo_mig"."fat_servico_unidade__dbt_tmp"
      end


   USE [papakura_20221223];
   EXEC('create view "dbo_mig"."fat_servico_unidade__dbt_tmp_temp_view" as
    


WITH 
TR AS (select DATEADD(DAY,-1,COALESCE(LAG(CRAT$DATE,1) OVER(PARTITION BY CRAT$CODE ORDER BY CRAT$DATE DESC),DATEADD(YEAR,1,CRAT$DATE))) CRAT$ENDDATE,* from "papakura_20221223"."dbo"."TARRATE" t 
)

,CTE AS (SELECT
GBI.GBIDATE as DT_GRAVACAO_SERVICO,
0 as NR_TOTAL_PARCELAS_SERVICO,
CAST(CASE WHEN GBSTRAN_AMOUNT <0 THEN GBSTRAN_AMOUNT * 1 ELSE GBSTRAN_AMOUNT END AS DECIMAL(16,2)) / 100 as VL_TOTAL_SERVICO,
''N'' as FL_POSSUI_PARCELA_FATURAR,
''N'' as FL_ATUALIZACAO_MONETARIA,
''N'' as FL_ORIGEM_FATURA_DIVIDA_ATIVA,
NULL as DT_MESANOREF_ORIGEM_MULTA,
NULL as VL_PERCENTUAL_JUROS_PARCELA,
null as FL_CONTABILIZADO,
GBI.GBIDATE  as DT_INICIO_FATURAMENTO,
''N'' as FL_SERVICO_DOACAO,
null as FL_SERVICO_HIDROMETRO,
null as ID_PARCELAMENTO_DEBITO,
TSD.ID_SERVICO_DEFINICAO as ID_SERVICO_DEFINICAO,
GBI.GBIINSTALL as CH_MATRICULA_UNIDADE,
NULL as ID_SERVICO_EXECUTADO,
NULL as ID_SERVICO_NAOEXECUTADO,
NULL as ID_SERVICO,
NULL as ID_REGISTRO_DOACAO,
NULL as ID_TABELA_TARIFARIA_MATERIAL,
21120001 as CH_TIPO_SERVICO,
GBI.GBIINVOICE as MIG_ID_FATURA_TEMP,
69 as MIG_ID_ESTRUTURA_ITEM_TEMP,
''S'' as MIG_FL_MIGRACAO_TEMP,
GBS.GBSTRAN_TRN_TYPE AS MIG_GBICTRN_TYPE_TEMP,
''N'' AS MIG_TARIFA_FIXA_TEMP,
NULL AS MIG_GBICSTARTDATE_TEMP,
NULL AS MIG_GBICENDDATE_TEMP,
NULL AS MIG_GBICUNITS_TEMP,
NULL AS MIG_GBICPLANID_TEMP,
NULL AS MIG_GBICRATE_TEMP_TEMP,
null as MIG_GBICCHARGE_TEMP,
NULL AS MIG_VMC_TEMP
FROM

"papakura_20221223"."dbo"."GBSTATEMENT#TRANS" GBS
INNER JOIN "papakura_20221223"."dbo_mig"."tab_servico_definicao" TSD ON TSD.GL_ID = GBS.GBSTRAN_TRN_TYPE
inner JOIN "papakura_20221223"."dbo"."GBINVOICE" GBI ON GBI.GBISTATEMENT_NO = GBS.GBSSTATEMENT
WHERE GBS.GBSTRAN_TRN_TYPE IN (''RESTOR'',''REST'',''MDC'',''SPEC'',''MIN'',''NAPP'',''MCONI'',''MCONIA'',''MCONIB'',''MCONIL'',''MCONR'',''MCONRU'',''MRELIC'',''MRELRA'',''MRELRN'',''MTEST'',''MTESTI'')

UNION

SELECT 

max(GBI.GBIDATE) as DT_GRAVACAO_SERVICO,
0 as NR_TOTAL_PARCELAS_SERVICO,
max(CASE WHEN CAST((COALESCE((GBC.GBICDOLLAR),0) + COALESCE((GBC.GBICTAX),0)) AS DECIMAL(16,2)) <0 THEN  
CAST((COALESCE((GBC.GBICDOLLAR),0) + COALESCE((GBC.GBICTAX),0)) AS DECIMAL(16,2)) * 1 ELSE CAST((COALESCE((GBC.GBICDOLLAR),0) + COALESCE((GBC.GBICTAX),0)) AS DECIMAL(16,2)) END / 100) as VL_TOTAL_SERVICO,
''N'' as FL_POSSUI_PARCELA_FATURAR,
''N'' as FL_ATUALIZACAO_MONETARIA,
''N'' as FL_ORIGEM_FATURA_DIVIDA_ATIVA,
NULL as DT_MESANOREF_ORIGEM_MULTA,
NULL as VL_PERCENTUAL_JUROS_PARCELA,
null as FL_CONTABILIZADO,
max(CASE WHEN GBC.GBICSTARTDATE > GBC.GBICENDDATE THEN GBC.GBICENDDATE ELSE GBC.GBICSTARTDATE END) as DT_INICIO_FATURAMENTO,
''N'' as FL_SERVICO_DOACAO,
null as FL_SERVICO_HIDROMETRO,
null as ID_PARCELAMENTO_DEBITO,
Max(TSD.ID_SERVICO_DEFINICAO) as ID_SERVICO_DEFINICAO,
MAX(GBI.GBIINSTALL) as CH_MATRICULA_UNIDADE,
NULL as ID_SERVICO_EXECUTADO,
NULL as ID_SERVICO_NAOEXECUTADO,
NULL as ID_SERVICO,
NULL as ID_REGISTRO_DOACAO,
NULL as ID_TABELA_TARIFARIA_MATERIAL,
21120001 as CH_TIPO_SERVICO,
MAX(GBI.GBIINVOICE) as MIG_ID_FATURA_TEMP,
69 as MIG_ID_ESTRUTURA_ITEM_TEMP,
''S'' as MIG_FL_MIGRACAO_TEMP,
MAX(GBC.GBICTRN_TYPE) AS MIG_GBICTRN_TYPE_TEMP,
CASE WHEN GBC.GBICCHARGE = ''MIN'' THEN ''N'' ELSE ''S'' END AS MIG_TARIFA_FIXA_TEMP,
MAX(CASE WHEN GBC.GBICSTARTDATE > GBC.GBICENDDATE THEN GBC.GBICENDDATE ELSE GBC.GBICSTARTDATE END) AS MIG_GBICSTARTDATE_TEMP,
MAX(CASE WHEN GBC.GBICENDDATE < GBC.GBICSTARTDATE THEN GBC.GBICSTARTDATE ELSE GBC.GBICENDDATE END) AS MIG_GBICENDDATE_TEMP,
MAX(GBC.GBICUNITS) AS MIG_GBICUNITS_TEMP,
MAX(GBC.GBICPLANID) AS MIG_GBICPLANID_TEMP,
MAX(GBC.GBICRATE) AS MIG_GBICRATE_TEMP_TEMP,
max(GBC.GBICCHARGE) AS MIG_GBICCHARGE_TEMP,
GBC.VMC AS MIG_VMC_TEMP


FROM

"papakura_20221223"."dbo"."GBINVOICE#CHARGES" GBC
INNER JOIN "papakura_20221223"."dbo"."GBINVOICE" GBI ON GBI.GBIINVOICE = GBC.GBIINVOICE

inner JOIN "papakura_20221223"."dbo_mig"."tab_servico_definicao" TSD ON cast(TSD.GL_ID as varchar)  = cast(GBC.GBICCHARGE as varchar)
where GBC.GBICCHARGE IS NOT NULL AND (GBC.GBICCHARGE IN (SELECT DISTINCT ECPLAN_FCHGCODE FROM "papakura_20221223"."dbo"."EMS_CON_PLAN#FIXED_LIST") OR (GBICCHARGE =''MIN'' AND (GBICDOLLAR + GBICTAX) >0)) 
GROUP BY GBC.GBIINVOICE,GBC.GBICTRN_TYPE,GBICCHARGE,GBC.GBICSTARTDATE, GBC.VMC 


)

SELECT *,ROW_NUMBER() OVER(ORDER BY MIG_ID_FATURA_TEMP) as ID_SERVICO_UNIDADE, cast(coalesce(CASE WHEN TR.CRAT$RATE =0 THEN MIG_GBICRATE_TEMP_TEMP ELSE TR.CRAT$RATE END ,MIG_GBICRATE_TEMP_TEMP) as decimal(16,3)) AS MIG_GBICRATE_TEMP 
 FROM CTE
 left join TR ON TR.CRAT$CODE = CTE.MIG_GBICCHARGE_TEMP AND (CTE.MIG_GBICSTARTDATE_TEMP>=TR.CRAT$DATE AND CTE.MIG_GBICENDDATE_TEMP <= TR.CRAT$ENDDATE)
    ');

   SELECT * INTO "papakura_20221223"."dbo_mig"."fat_servico_unidade__dbt_tmp" FROM
    "papakura_20221223"."dbo_mig"."fat_servico_unidade__dbt_tmp_temp_view"

   
   
  USE [papakura_20221223];
  if object_id ('"dbo_mig"."fat_servico_unidade__dbt_tmp_temp_view"','V') is not null
      begin
      drop view "dbo_mig"."fat_servico_unidade__dbt_tmp_temp_view"
      end


   use [papakura_20221223];
  if EXISTS (
        SELECT * FROM
        sys.indexes WHERE name = 'dbo_mig_fat_servico_unidade__dbt_tmp_cci'
        AND object_id=object_id('dbo_mig_fat_servico_unidade__dbt_tmp')
    )
  DROP index "dbo_mig"."fat_servico_unidade__dbt_tmp".dbo_mig_fat_servico_unidade__dbt_tmp_cci
  CREATE CLUSTERED COLUMNSTORE INDEX dbo_mig_fat_servico_unidade__dbt_tmp_cci
    ON "dbo_mig"."fat_servico_unidade__dbt_tmp"

   

