WITH SEL AS (select G.*, VALUE AS PARAMETROS  from GBIACCRUAL G CROSS APPLY STRING_SPLIT(G.GBILOCN_ADDR,','))

,base AS (SELECT SEL.*, VALUE AS LOGRADOURO,
CASE 
	WHEN ISNUMERIC(VALUE) = 1 THEN 'NUMERO'
	WHEN ISNUMERIC(VALUE) = 0 AND value in (SELECT PDESC FROM {{source('papakura','STREET_TYPE')}}) THEN 'TIPO_LOGRADOURO'
	when  ISNUMERIC(VALUE) = 0 AND value not in (SELECT PDESC FROM {{source('papakura','STREET_TYPE')}}) and value not in ('ALFRISTON','ARDMORE','CONIFER GROVE','DRURY','KARAKA','OPAHEKE','PAHUREHURE','PAPAKURA','RANDWICH PARK','RED HILL','REDHILL','ROSEHILL','TAKANINI') then 'LOGRADOURO'
	ELSE 'TEXT'
END AS TIPO




FROM SEL CROSS APPLY STRING_SPLIT(SEL.PARAMETROS,' '))


select GBIINSTALL, STRING_AGG(LOGRADOURO, ' ') AS LOGRADOURO from base
WHERE TIPO = 'LOGRADOURO'
GROUP BY GBIINSTALL
