with base as (SELECT
ROW_NUMBER() OVER(ORDER BY DEBT.DLEDGER,DEBT.DDATETIME,DEBT.DKEY) as ID_CONTA_CORRENTE_MOVIMENTACAO,
coalesce(DEBT.DDATETIME, GETDATE()) as DT_MOVIMENTACAO,
coalesce(CAST(DEBT.DAMT AS DECIMAL(18,2))/100, 0.0)  as VL_MOVIMENTACAO,
case when row_number() over(PARTITION BY DEBT.DLEDGER ORDER BY DEBT.DDATETIME desc ) =1  then cast(L.LR$BAL as decimal(16,2))/100 else

coalesce(SUM(CAST(
--     case when DEBT.DTYPE IN ('AMIN') 
-- -- or left(DEBT.DTYPE,1) = 'A' 
-- then DEBT.DAMT * 0 else DEBT.DAMT end 
DEBT.DAMT
AS DECIMAL(18,2))) OVER(PARTITION BY DEBT.DLEDGER ORDER BY DEBT.DDATETIME ASC,DEBT.DKEY asc ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW)/100,0.0) end as VL_SALDO_ATUAL,

DEBT.DLEDGER as ID_CONTA_CORRENTE,
CASE
    WHEN DEBT.DTYPE = 'AIC'     THEN 40970004
    WHEN DEBT.DTYPE = 'ACSH'    THEN 40970003
    WHEN DEBT.DTYPE = 'ALLOW'   THEN 40970004
    WHEN DEBT.DTYPE = 'ALLOWQ'  THEN 40970004
    WHEN DEBT.DTYPE = 'AMIN'    THEN 40970004
    WHEN DEBT.DTYPE = 'ANAPP'   THEN 40970004
    WHEN DEBT.DTYPE = 'ASFIXR'  THEN 40970004
    WHEN DEBT.DTYPE = 'ASFIXT'  THEN 40970004
    WHEN DEBT.DTYPE = 'ASFIXW'  THEN 40970004
    WHEN DEBT.DTYPE = 'ASPEC'   THEN 40970004
    WHEN DEBT.DTYPE = 'ASSERV'  THEN 40970004
    WHEN DEBT.DTYPE = 'ASTREA'  THEN 40970004
    WHEN DEBT.DTYPE = 'ASVOL'   THEN 40970004
    WHEN DEBT.DTYPE = 'AWSERV'  THEN 40970004
    WHEN DEBT.DTYPE = 'AWSUPP'  THEN 40970004
    WHEN DEBT.DTYPE = 'AWVOL'   THEN 40970004
    WHEN DEBT.DTYPE = 'BAYC'    THEN 40970002
    WHEN DEBT.DTYPE = 'BSAPP'   THEN 40970002
    WHEN DEBT.DTYPE = 'CALL'    THEN 40970002
    WHEN DEBT.DTYPE = 'CCTV'    THEN 40970002
    WHEN DEBT.DTYPE = 'CSH'     THEN 40970003
    WHEN DEBT.DTYPE = 'DAP'     THEN 40970004
    WHEN DEBT.DTYPE = 'DCC'     THEN 40970004
    WHEN DEBT.DTYPE = 'DCF'     THEN 40970003
    WHEN DEBT.DTYPE = 'DCQ'     THEN 40970004
    WHEN DEBT.DTYPE = 'DCR'     THEN 40970003
    WHEN DEBT.DTYPE = 'DDD'     THEN 40970004
    WHEN DEBT.DTYPE = 'DFEE'    THEN 40970004
    WHEN DEBT.DTYPE = 'DINS'    THEN 40970002
    WHEN DEBT.DTYPE = 'ENGI'    THEN 40970002
    WHEN DEBT.DTYPE = 'GOOD'    THEN 40970004
    WHEN DEBT.DTYPE = 'HYDC'    THEN 40970002
    WHEN DEBT.DTYPE = 'HYDPM'   THEN 40970002
    WHEN DEBT.DTYPE = 'HYDPW'   THEN 40970002
    WHEN DEBT.DTYPE = 'HYDPY'   THEN 40970002
    WHEN DEBT.DTYPE = 'IC'      THEN 40970002
    WHEN DEBT.DTYPE = 'INT'     THEN 40970004
    WHEN DEBT.DTYPE = 'INV'     THEN 40970001
    WHEN DEBT.DTYPE = 'MBUR'    THEN 40970002
    WHEN DEBT.DTYPE = 'MCONI'   THEN 40970002
    WHEN DEBT.DTYPE = 'MCONIA'  THEN 40970002
    WHEN DEBT.DTYPE = 'MCONIB'  THEN 40970002
    WHEN DEBT.DTYPE = 'MCONIL'  THEN 40970002
    WHEN DEBT.DTYPE = 'MCONR'   THEN 40970002
    WHEN DEBT.DTYPE = 'MCONRU'  THEN 40970002
    WHEN DEBT.DTYPE = 'MDC'     THEN 40970002
    WHEN DEBT.DTYPE = 'MIN'     THEN 40970002
    WHEN DEBT.DTYPE = 'MIS'     THEN 40970002
    WHEN DEBT.DTYPE = 'MRELIC'  THEN 40970002
    WHEN DEBT.DTYPE = 'MRELRA'  THEN 40970002
    WHEN DEBT.DTYPE = 'MRELRN'  THEN 40970002
    WHEN DEBT.DTYPE = 'MTEST'   THEN 40970002
    WHEN DEBT.DTYPE = 'MTESTI'  THEN 40970002
    WHEN DEBT.DTYPE = 'NAPP'    THEN 40970002
    WHEN DEBT.DTYPE = 'NDEP'    THEN 40970002
    WHEN DEBT.DTYPE = 'NPPM'    THEN 40970002
    WHEN DEBT.DTYPE = 'OTH'     THEN 40970002
    WHEN DEBT.DTYPE = 'RESOFF'  THEN 40970007
    WHEN DEBT.DTYPE = 'RESON'   THEN 40970002
    WHEN DEBT.DTYPE = 'RESONF'  THEN 40970002
    WHEN DEBT.DTYPE = 'REST'    THEN 40970002
    WHEN DEBT.DTYPE = 'RESTA'   THEN 40970004
    WHEN DEBT.DTYPE = 'RESTOR'  THEN 40970002
    WHEN DEBT.DTYPE = 'RFD'     THEN 40970004
    WHEN DEBT.DTYPE = 'RFF'     THEN 40970002
    WHEN DEBT.DTYPE = 'RMT'     THEN 40970008
    WHEN DEBT.DTYPE = 'ROUND'   THEN 40970004
    WHEN DEBT.DTYPE = 'SFIXR'   THEN 40970002
    WHEN DEBT.DTYPE = 'SFIXTW'  THEN 40970002
    WHEN DEBT.DTYPE = 'SFIXWW'  THEN 40970002
    WHEN DEBT.DTYPE = 'SPEC'    THEN 40970002
    WHEN DEBT.DTYPE = 'SSERV'   THEN 40970002
    WHEN DEBT.DTYPE = 'STREA'   THEN 40970002
    WHEN DEBT.DTYPE = 'SVOL'    THEN 40970002
    WHEN DEBT.DTYPE = 'TRF'     THEN 40970008
    WHEN DEBT.DTYPE = 'WCART'   THEN 40970002
    WHEN DEBT.DTYPE = 'WSERV'   THEN 40970002
    WHEN DEBT.DTYPE = 'WSUPP'   THEN 40970002
    WHEN DEBT.DTYPE = 'WVOL'    THEN 40970002
    WHEN DEBT.DTYPE = 'FATURA'  AND FAT_CANC = 0 THEN 40970001
    WHEN DEBT.DTYPE = 'FATURA'  AND FAT_CANC = 1 THEN 40970005
    else 40970002
END as CH_TIPO_MOVIMENTACAO_CONTA_CORRENTE,
row_number() over(PARTITION BY DEBT.DLEDGER ORDER BY DEBT.DDATETIME ASC,DEBT.DKEY ASC) as NR_SEQUENCIAL_REGISTRO,
NULL as ID_USUARIO,
DEBT.DLEDGER AS LEDGERID,
DEBT.DSTATEMENT AS  STATEMENT,
DEBT.DINVOICEREF AS INVOICE,
DEBT.DTYPE as DTYPE,
DEBT.DLEDGER AS MIG_LEDGERID_TEMP,
DEBT.DSTATEMENT AS  MIG_STATEMENT_TEMP,
DEBT.DINVOICEREF AS MIG_INVOICE_TEMP,
DEBT.DTYPE as MIG_DTYPE_TEMP,
DEBT.DKEY AS MIG_DKEY_TEMP,
DEBT.DDATEDUE AS MIG_DDATEDUE_PK_TEMP,
DEBT.DDATETIME AS MIG_DDATETIME_TEMP,
L.LR$BAL as MIG_BALANCE_TEMP,
COALESCE(lag (DEBT.DSTATEMENT,1) over(partition by DEBT.DLEDGER ORDER BY DKEY ASC),DSTATEMENT) AS  MIG_CORRECT_INVOICE_TEMP
FROM
{{ref('stage_debt')}} DEBT
left join {{source('papakura','LEDGER')}} L ON L.LEDGERID = DEBT.DLEDGER


)


select base.*
-- ,
-- case 
-- when row_number() over(PARTITION BY MIG_LEDGERID_TEMP ORDER BY NR_SEQUENCIAL_REGISTRO desc ) = 1  then cast(MIG_BALANCE_TEMP as decimal(16,2))/100 

-- ELSE COALESCE(SUM(
-- --     case when DEBT.DTYPE IN ('AMIN') 
-- -- -- or left(DEBT.DTYPE,1) = 'A' 
-- -- then DEBT.DAMT * 0 else DEBT.DAMT end 
-- VL_MOVIMENTACAO)
--  OVER(PARTITION BY MIG_LEDGERID_TEMP ORDER BY NR_SEQUENCIAL_REGISTRO asc ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW),0.0) end as VL_SALDO_ATUAL

From base