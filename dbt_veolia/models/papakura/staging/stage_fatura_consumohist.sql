with CONSUMO_INTERM as (select GBIR.GBIINVOICE,
CASE WHEN GBIR.GBIMCURR_TYPE IS NULL THEN 'AB' ELSE GBIR.GBIMCURR_TYPE END  as GBIMCURR_TYPE_ADJ,
ROW_NUMBER() OVER(PARTITION BY GBIR.GBIINVOICE ORDER BY VMC DESC)  AS RN from GBINVOICE#REGISTERS GBIR)

,CONSUMO_HIST AS (SELECT GBIINVOICE, GBIMCURR_TYPE_ADJ FROM CONSUMO_INTERM WHERE RN=1)

select * FROM CONSUMO_HIST